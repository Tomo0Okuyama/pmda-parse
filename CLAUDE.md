# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
医者が、過去の検査結果やバイタルデータ、あるいは対面での診療行為において得られた情報をもとに、最も適した処方薬をレコメンドするサービスを作ろうと考えています。
イメージ的には、医者が口頭で患者にヒアリングをし、患者が答える内容をDictationし、その行為を続けている最中もDictationできた内容から適切な処方薬の情報を逐次更新する内容です。
ヒアリングをした当初は多くの医薬品が候補としてあげられていても、ヒアリングを続け情報が増えるごとに候補が絞られていくような動作をイメージしています。
そのために必要な医薬品の情報をデータ化したいと考えていますが。PMDAでは、医薬品の情報をXML/SGMLという構造化文書や、PDFの添付文書で公開しているものの、添付文書に記載すべき内容についてはある程度統一されているが、XML/SGMLでは統一がなされていません。
現時点では、医薬品の効能や効用、警告、禁忌、併用注意医薬品、副作用などについて、複数の医薬品で関連している情報をもつことから、医薬品についてグラフDBを用意し、また、各情報については、医師が処方薬を選ぶ上での選定プロセスを鑑み、XML/SGMLからパースして得られた情報を複数のベクトルDBで構成し、既往歴や検査結果、過去の処方薬、口頭での診療行為で得られた情報などから適切な医薬品を案内するサービスを作りたい。統一かされていなXMLやSGML、内容にメーカーごとの記載の揺れがあるPDF文書から、RAGのための情報や、ベクトルDBのための情報を得る方法について、考察し、まとめて。また、合わせて、このようなテクノロジを用いた方が良いなどの情報があれば、それもまとめて。

## Project Setup
このワークスペースでは、PMDAが公開している医薬品情報ファイルのXML/SGMLから以下の情報を取り出し、1つのJSONファイルにデータを集約するためのPythonコードファイルを作成しています。
全てのコードは./srcフォルダ配下に配置します。

## 設計指針
医薬品のXML/SGMLから以下の内容を含むデータを取得し、それをJSONに記録します。

### 必須情報
- 製品ID
- 製品名称
- YJコード
- 剤形
- 製造元コード
- 製造元名称（役割プレフィックスなし）
- ソースファイル名

### 医療情報（条件別・重篤度別に構造化）
- **効能・効果**: 対象疾患や症状に対して薬剤がどのような治療効果を持つか
- **用法・用量**: 適切な投与方法と投与量（条件固有：`疾患:対象者:用法`）
  - **複雑な投与プロトコル対応**: 抗癌剤等のA法〜F法パターンと体表面積別用量テーブル
- **禁忌**: 投与してはいけない患者背景や併用薬、疾患
- **警告・注意事項**: 投与時に特に注意すべき事項や、重篤なリスク
- **副作用**: 重篤度分類された有害事象（`重篤:副作用名:説明` または `非重篤:条件:副作用`）
- **相互作用**: 併用薬や食品との相互作用によるリスク
- **成分・含量**: 有効成分の種類とその含有量（構造化されたカテゴリ別出力）
- **有効成分詳細**: 一般名、化学名、分子式、分子量、性状等の物理化学的情報（構造式情報除く）

## データ出力ポリシー
- **データ削減なし**: 全ての有効な医療情報を保持
- **重複除去のみ**: カテゴリ内での完全重複のみ除去
- **構造化優先**: 条件別・重篤度別の情報を適切に分類
- **原値保持**: XML/SGMLの元の値を分割せずに保持（例：「250国際単位」）
- **重篤度優先**: 副作用データでは重篤度を先頭に配置（`非重篤:条件:副作用`）

## JSON出力構造例

```json
{
  "product_id": "430773_2149040F1069_1_10",
  "product_name": "カンデサルタン錠8mg「DSEP」",
  "yj_code": "2149040F3061",
  "form": "持続性アンジオテンシンⅡ受容体拮抗剤",
  "manufacturer_code": "430773",
  "manufacturer_name": "第一三共エスファ株式会社",
  "source_filename": "430773_2149040F1069_1_10.xml",
  "clinical_info": {
    "indications": [
      "高血圧症",
      "腎実質性高血圧症", 
      "慢性心不全"
    ],
    "dosage": [
      "高血圧症:成人:通常、成人には1日1回4～8mgを経口投与し、必要に応じ12mgまで増量する",
      "高血圧症:小児:通常、1歳以上6歳未満の小児には1日1回0.05～0.3mg/kgを経口投与する",
      "腎実質性高血圧症:通常、成人には1日1回2mgから経口投与を開始し、必要に応じ8mgまで増量する",
      "慢性心不全:通常、成人には1日1回4mgから経口投与を開始し、必要に応じ8mgまで増量できる"
    ],
    
    // 複雑な投与プロトコル例（抗癌剤：カペシタビン等）
    "dosage_complex_example": [
      "手術不能又は再発乳癌にはA法又はB法を使用し、ラパチニブトシル酸塩水和物と併用する場合にはC法を使用する。結腸・直腸癌における補助化学療法にはB法を使用し、オキサリプラチンと併用する場合にはC法を使用する。治癒切除不能な進行・再発の結腸・直腸癌には他の抗悪性腫瘍剤との併用でC法又はE法を使用する。直腸癌における補助化学療法で放射線照射と併用する場合にはD法を使用する。胃癌には白金製剤との併用でC法を使用する",
      "A法:朝食後と夕食後30分以内に1日2回、21日間連日経口投与し、その後7日間休薬/体表面積1.31m²未満:900mg、1.31m²以上1.64m²未満:1,200mg、1.64m²以上:1,500mg",
      "B法:朝食後と夕食後30分以内に1日2回、14日間連日経口投与し、その後7日間休薬/体表面積1.33m²未満:1,500mg、1.33m²以上1.57m²未満:1,800mg、1.57m²以上1.81m²未満:2,100mg、1.81m²以上:2,400mg"
    ],
    "contraindications": [
      "本剤の成分に対し過敏症の既往歴のある患者",
      "妊婦又は妊娠している可能性のある女性"
    ],
    "warnings": [
      "血管浮腫があらわれることがあるので、観察を十分に行うこと"
    ],
    "side_effects": [
      "重篤:血管浮腫（頻度不明）:顔面、口唇、舌、咽・喉頭等の腫脹を症状とする血管浮腫があらわれることがある",
      "重篤:ショック（頻度不明）、失神、意識消失:冷感、嘔吐、意識消失等があらわれた場合には、直ちに適切な処置を行うこと",
      "非重篤:高血圧症:めまい、ふらつき、立ちくらみ、動悸、ほてり",
      "非重篤:高血圧症:発疹、湿疹、蕁麻疹、そう痒、光線過敏症",
      "非重篤:慢性心不全:貧血、白血球減少、白血球増多、好酸球増多、血小板減少"
    ],
    "interactions": [
      "薬物:リチウム製剤 - 機序:腎尿細管でのリチウムの再吸収が促進される"
    ],
    "compositions": {
      "active_ingredients": [
        {"ingredient_name": "カンデサルタン シレキセチル", "value_and_unit": "8.0mg"}
      ],
      "additives": [
        {"individual_additive": "L-ヒスチジン", "value_and_unit": "7.8mg"},
        {"individual_additive": "ポリソルベート80", "value_and_unit": "0.5mg"}
      ],
      "other_components": []
    },
    "active_ingredients": [
      {
        "general_name": "カンデサルタン シレキセチル",
        "chemical_name": "2-エトキシ-1-{[2'-(1H-テトラゾール-5-イル)ビフェニル-4-イル]メチル}-1H-ベンゾイミダゾール-7-カルボン酸",
        "molecular_formula": "C24H20N6O3",
        "molecular_weight": "440.45",
        "nature": "白色の結晶性の粉末である。"
      }
    ]
  }
}
```

## アーキテクチャ

### パーサー設計
各医療情報カテゴリは独立したパーサーモジュールで処理：
- `./src/parsers/base_parser.py` - 必須情報（製品ID、名称、メーカー情報等）
- `./src/parsers/indication_parser.py` - 効能・効果
- `./src/parsers/dosage_parser.py` - 用法・用量（条件固有処理対応）
- `./src/parsers/contraindication_parser.py` - 禁忌
- `./src/parsers/warning_parser.py` - 警告・注意事項
- `./src/parsers/side_effect_parser.py` - 副作用（重篤度分類対応）
- `./src/parsers/interaction_parser.py` - 相互作用
- `./src/parsers/composition_parser.py` - 成分・含量（構造化対応）
- `./src/parsers/active_ingredient_parser.py` - 有効成分詳細情報（PhyschemOfActIngredients対応）

### データ処理フロー
1. **ファイル重複チェック**: SHA-256ハッシュによる同一XMLファイル検出・除去
2. **必須情報取得**: 製品ID、名称、YJコード、剤形、メーカー情報
3. **医療情報パース**: 各専用パーサーによる条件別・重篤度別情報抽出
4. **JSON出力**: 構造化されたclinical_info形式での出力
5. **サマリー出力**: 処理統計（医薬品数、各項目数、ファイルサイズ等）

### XMLパース仕様
- **名前空間**: `http://info.pmda.go.jp/namespace/prescription_drugs/package_insert/1.0`
- **ネストしたHeader処理**: 疾患条件と対象者の階層構造を適切に解析
- **重篤度自動分類**: SeriousAdverseEvents/OtherAdverseEventsに基づく分類
- **条件固有情報**: XMLのHeader要素から条件を抽出してプレフィックス付与

## データ品質保証
- **完全データ保持**: フィルタリングや削減処理なし
- **重複除去**: カテゴリ内での完全重複のみ除去
- **医療情報整合性**: 添付文書の構造に忠実な情報抽出




## 開発環境
- Python仮想環境 (`.venv`) を使用
- 開発前に仮想環境をアクティベート: `source .venv/bin/activate`
- 依存関係: xml.etree.ElementTree, hashlib, argparse等（標準ライブラリ中心）

## 実行方法
```bash
# メイン実行（デフォルト出力: pmda_medicines.json）
python src/pmda_json_generator.py

# 出力ファイル指定
python src/pmda_json_generator.py --output /path/to/output.json

# テスト実行
python test_nested_dosage.py
python test_side_effects.py
```

## 重要な実装注意点
1. **用法・用量**: `_process_nested_items`でネストしたXML構造を再帰処理
   - **複雑な投与プロトコル**: A法〜F法パターンと体表面積別用量テーブルの自動検出・パース
   - **抗癌剤対応**: カペシタビン、TS-1、イリノテカン、パクリタキセル等の複雑な投与法
   - **XML構造ベース**: テキストではなくXML構造で投与法パターンを判定
2. **副作用**: 重篤度を必ず`重篤:`または`非重篤:`で開始（重篤度優先フォーマット）
3. **条件抽出**: Header要素の〈〉形式と一般的な条件名の両方に対応
4. **重複除去**: カテゴリ内でのみ実行、カテゴリ間では保持
5. **メーカー情報**: 役割プレフィックス（製造販売元等）を除去して企業名のみ保持
6. **剤形抽出**: FormulationとColorToneの組み合わせ対応（例：`素錠:白色`）
   - PropertyForConstituentUnitsの外観・性状情報も対応
7. **成分・含量**: 有効成分と添加物の名称・重量を適切にペアリングして抽出
   - `ContainedAmount`要素から有効成分名と含量をペアで取得
   - `InfoIndividualAdditive`要素から添加物名と含量をペアで取得
   - 重量情報がない場合は成分名のみ出力
   - カテゴリ別構造化出力（active_ingredients, additives, other_components）
8. **有効成分詳細**: PhyschemOfActIngredientsセクションから物理化学的情報を抽出
   - 一般名、化学名、分子式、分子量、性状等の詳細情報
   - 構造式情報は医師の処方選定には不要のため除外
   - XML内のタグ処理（Italic、Sub、Sup等）を適切に処理
9. **原値保持**: XML/SGMLの値を分割せずに保持（例：「250国際単位」をそのまま保持）
10. **XML構造ベースパース**: 文章内容ではなくXML構造を基準にパース処理を実行