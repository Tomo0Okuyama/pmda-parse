# PMDA Medical Drug Information Parser

PMDAが公開している医薬品情報ファイル（XML/SGML）から医療従事者向けの構造化された情報を抽出し、ベクトル検索に最適化されたJSONデータを生成するPythonパーサーです。

## 概要

このリポジトリは、PMDA（医薬品医療機器総合機構）の医薬品データファイル(XML/SGML)から以下の情報を抽出・構造化し、医師が診断や診療から適切な医薬品を効率的に検索できるシステムの構築を支援します。

### 抽出される情報

**必須情報:**
- 製品ID
- 製品名称
- YJコード
- 剤形（Formulation:ColorTone形式または性状情報）
- 製造元（企業コードと企業名）
- ソースファイル名

**医療情報（条件別・重篤度別に構造化）:**
- **効能・効果**: 対象疾患や症状に対する治療効果
- **用法・用量**: 条件固有の投与方法（例: `高血圧症:成人:通常、成人には...`）
  - **複雑な投与プロトコル対応**: 抗癌剤等のA法〜F法パターンと体表面積別用量テーブル
  - **対応薬剤**: カペシタビン、TS-1、イリノテカン、パクリタキセル等
- **禁忌**: 投与禁止の患者背景や併用薬、疾患
- **警告・注意事項**: 投与時の重要な注意点やリスク
- **副作用**: 重篤度分類された有害事象（例: `重篤:血管浮腫:説明`、`非重篤:高血圧症:発疹`）
- **相互作用**: 併用薬や食品との相互作用
- **成分・含量**: 有効成分と添加物の名称・含有量のペア情報（構造化）
- **有効成分詳細**: 物理化学的情報（一般名、化学名、分子式、分子量、性状等）

## 特徴

### 1. 条件固有の用法・用量抽出
XMLのネストしたHeader構造を適切に処理し、疾患や患者条件に応じた用法・用量を抽出：
```json
"dosage": [
  "高血圧症:成人:通常、成人には1日1回4～8mgを経口投与...",
  "高血圧症:小児:通常、1歳以上6歳未満の小児には...",
  "腎実質性高血圧症:通常、成人には1日1回2mgから..."
]
```

### 1-2. 抗癌剤複雑投与プロトコル対応
抗癌剤等で使用される複雑な投与法（A法〜F法）と体表面積別用量テーブルを自動検出・解析：
```json
"dosage": [
  "適応症に応じて下記の投与法を選択する",
  "A法:1日2回朝夕食後、1回2〜3錠を21日間連日経口投与し、7日間休薬する/体表面積1.25m²未満:朝2錠、夕1錠、1.25〜1.5m²未満:朝2錠、夕2錠、1.5m²以上:朝3錠、夕2錠",
  "B法:1日2回朝夕食後、1回2〜3錠を14日間連日経口投与し、7日間休薬する/体表面積1.25m²未満:朝2錠、夕1錠、1.25〜1.5m²未満:朝2錠、夕2錠、1.5m²以上:朝3錠、夕2錠"
]
```

### 2. 重篤度分類された副作用情報
重篤な副作用とその他の副作用を明確に分類（重篤度優先フォーマット）：
```json
"side_effects": [
  "重篤:血管浮腫（頻度不明）:顔面、口唇、舌、咽・喉頭等の腫脹...",
  "非重篤:高血圧症:めまい、ふらつき、立ちくらみ、動悸...",
  "非重篤:慢性心不全:発疹、湿疹、蕁麻疹..."
]
```

### 3. 高性能な重複除去
- SHA-256ハッシュによるファイル重複検出
- カテゴリ内での完全重複除去
- 大規模データセットの効率的処理

### 4. 成分・含量の精密抽出
有効成分と添加物の名称・重量を正確にペアリング（構造化出力）：
```json
"compositions": [
  "有効成分:アルテプラーゼ（遺伝子組換え) 1200万国際単位",
  "添加物:L-アルギニン 653mg",
  "添加物:ポリソルベート80 1.8mg",
  "添加物:リン酸"
]
```

### 5. 完全データ保持
- データ量削減フィルタなし
- 全ての有効な医療情報を保持
- 医療従事者の詳細な検索ニーズに対応
- 原値保持（「250国際単位」を分割せずに保持）

### 6. 有効成分詳細情報
PhyschemOfActIngredientsセクションからの物理化学的情報抽出（構造式情報除く）：
```json
"active_ingredients": [
  {
    "general_name": "レボセチリジン塩酸塩（Levocetirizine Hydrochloride）",
    "chemical_name": "2-（2-｛4-［（R）-（4-Chlorophenyl）phenylmethyl］piperazin-1-yl｝ethoxy）acetic acid dihydrochloride",
    "molecular_formula": "C21H25ClN2O3・2HCl",
    "molecular_weight": "461.81",
    "nature": "白色の結晶性の粉末である。"
  }
]
```

### 7. XML構造ベースの解析
- テキスト内容に依存しない、XML構造を基準とした情報抽出
- PMDAの標準的なXML名前空間に対応
- 製薬企業ごとの記載の揺れに影響されない堅牢な解析

### 8. 改良された剤形抽出
- Formulation + ColorTone要素の組み合わせ（例：「素錠:白色」）
- PropertyForConstituentUnitsからの外観・性状情報フォールバック
- DosageFormや薬効分類からの代替取得

## プロジェクト構造

```
pmda-parse/
├── .gitignore                            # Git除外設定
├── README.md                             # このファイル（日本語）
├── README_EN.md                          # 英語版README
├── requirements.txt                      # Python依存関係定義
└── src/
    ├── pmda_json_generator.py            # メイン実行ファイル（通常版）
    ├── pmda_json_generator_optimized.py  # 最適化版（並列処理・高速化）
    ├── parsers/
    │   ├── base_parser.py                # 基本パーサー（必須情報抽出）
    │   ├── indication_parser.py          # 効能・効果パーサー
    │   ├── dosage_parser.py              # 用法・用量パーサー（複雑投与プロトコル対応）
    │   ├── contraindication_parser.py    # 禁忌パーサー
    │   ├── warning_parser.py             # 警告・注意事項パーサー
    │   ├── side_effect_parser.py         # 副作用パーサー（重篤度対応）
    │   ├── interaction_parser.py         # 相互作用パーサー
    │   ├── composition_parser.py         # 成分・含量パーサー（構造化・重複除去対応）
    │   ├── active_ingredient_parser.py   # 有効成分詳細パーサー
    │   ├── shared_xml_processor.py       # 最適化版専用：共有XMLプロセッサー
    │   └── xml_utils.py                  # 共通XMLユーティリティ関数
    └── utils/
        └── file_processor.py             # ファイル処理・重複除去ユーティリティ
```

※ PMDAデータディレクトリ（`pmda_all_nnnnnnnn/`）と出力JSONファイル（`*.json`）は`.gitignore`で除外されており、ローカルでのみ使用されます。

## 使用方法

### 環境設定

#### Python要件
- Python 3.7以上
- 外部依存: `psutil` (システム監視用、最適化版で使用)

#### セットアップ手順
```bash
# リポジトリのクローン
git clone <repository-url>
cd pmda-parse

# 仮想環境の作成・アクティベート
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# または
.venv\Scripts\activate     # Windows

# 依存関係インストール
pip install -r requirements.txt
```

#### 依存関係について
このプロジェクトは軽量設計で、主にPython標準ライブラリを使用します：
- **標準ライブラリ**: xml.etree.ElementTree、json、os、argparse等
- **外部ライブラリ**: psutil（最適化版のシステム監視用のみ）

### 基本実行

#### 通常版（シングルプロセス）
```bash
# 全医薬品データの処理（デフォルト出力: pmda_medicines.json）
python src/pmda_json_generator.py pmda_all_20250709

# 出力ファイル指定
python src/pmda_json_generator.py pmda_all_20250709 --output custom_output.json
```

#### 最適化版（並列処理・高速化）
```bash
# 最適化版実行（デフォルト出力: pmda_medicines_optimized.json）
python src/pmda_json_generator_optimized.py

# カスタム設定での実行
python src/pmda_json_generator_optimized.py --input pmda_all_20250709 --output custom_output.json --workers 8

# メモリ制限とバッチサイズ指定
python src/pmda_json_generator_optimized.py --memory-limit 4096 --batch-size 200
```

### 実行例

#### 通常版実行例
```bash
$ python src/pmda_json_generator.py pmda_all_20250709
=== PMDA医薬品データJSON生成開始 ===
1. ファイル発見中...
   発見されたファイル数: 18,164
2. 重複ファイル除去中...
   重複ファイル数: 6,700
   処理対象ファイル数: 11,464
3. 医薬品データ処理中...
   進捗: 11400/11464 (99.4%)
4. データ処理完了
   処理された医薬品数: 18,229
5. JSONファイル出力中...
   出力完了: pmda_medicines.json
   ファイルサイズ: 195.27 MB

=== 処理サマリー ===
発見されたファイル数: 18,164
重複ファイル数: 6,700
処理成功ファイル数: 11,464
処理エラーファイル数: 0
生成された医薬品エントリー数: 18,229
処理時間: 204.85秒
処理速度: 56.0ファイル/秒, 89.0医薬品エントリー/秒

=== 抽出された臨床情報 ===
効能・効果  :   45,137件
用法・用量  :   41,891件
成分・含量  :   54,019件
有効成分    :   15,095件
禁忌        :   72,475件
副作用      :  110,324件
相互作用    :   62,801件
警告・注意  :  186,865件
総臨床情報数:  588,607件

=== 医療情報種別毎の医薬品数 ===
効能・効果:   18,076件 ( 99.2%)
用法・用量:   18,004件 ( 98.8%)
成分・含量:   18,205件 ( 99.9%)
有効成分  :   15,095件 ( 82.8%)
禁忌      :   14,397件 ( 79.0%)
副作用    :   13,794件 ( 75.7%)
相互作用  :   15,831件 ( 86.9%)
警告・注意:   16,252件 ( 89.2%)

全種類の医療情報を持つ医薬品: 13,794件
```

#### 最適化版実行例
```bash
$ python src/pmda_json_generator_optimized.py
=== PMDA医薬品データJSON生成（最適化版） ===
並列処理ワーカー数: 14
プロセスプール使用: はい
システム情報:
  - CPU数: 14
  - 総メモリ: 36.0GB
  - 利用可能メモリ: 14.2GB
  - メモリ制限: 2048MB

1. データファイル検索中...
   発見されたファイル数: 18,164
2. 重複ファイル除去中...
   重複ファイル数: 6,700
   処理対象ファイル数: 11,464
3. インテリジェントバッチ分割中...
   バッチサイズ自動計算: 457
   - 利用可能メモリ: 14506.7MB
   - CPU数: 14
   - メモリ制限: 2048MB
   総バッチ数: 26
   平均バッチサイズ: 440.9ファイル/バッチ
4. 最適化並列バッチ処理開始...
   バッチ進捗: 26/26 (100.0%) | バッチ25: 704件 | 速度: 3.2 batches/sec
5. JSON出力中...
   出力ファイル: pmda_medicines_optimized.json
   ファイルサイズ: 195.27 MB

=== 処理サマリー（最適化版） ===
発見されたファイル数: 18,164
重複ファイル数: 6,700
処理成功ファイル数: 11,464
処理エラーファイル数: 0
生成された医薬品エントリー数: 18,229
処理時間: 23.07秒
並列ワーカー数: 14

=== 最適化効果 ===
XMLパース回数: 11,464回
従来方式のパース回数: 103,176回（予想）
XMLパース削減率: 88.9%

=== 処理速度 ===
ファイル処理速度: 496.85 files/sec
医薬品生成速度: 790.50 medicines/sec

🚀 最適化JSON生成が完了しました: pmda_medicines_optimized.json
⚡ バッチ分割 + 並列処理による高速化を実現
```

## 出力データ形式

```json
{
  "yj_code": "2149040F3061",
  "product_name": "カンデサルタン錠8mg「DSEP」",
  "form": "持続性アンジオテンシンⅡ受容体拮抗剤",
  "manufacturer_code": "430773",
  "manufacturer_name": "第一三共エスファ株式会社", 
  "source_filename": "430773_2149040F1069_1_10.xml",
  "clinical_info": {
    "indications": [
      "高血圧症",
      "腎実質性高血圧症",
      "慢性心不全"
    ],
    "dosage": [
      "高血圧症:成人:通常、成人には1日1回4～8mgを経口投与し、必要に応じ12mgまで増量する",
      "高血圧症:小児:通常、1歳以上6歳未満の小児には1日1回0.05～0.3mg/kgを経口投与する",
      "腎実質性高血圧症:通常、成人には1日1回2mgから経口投与を開始し、必要に応じ8mgまで増量する"
    ],
    "contraindications": [
      "本剤の成分に対し過敏症の既往歴のある患者",
      "妊婦又は妊娠している可能性のある女性"
    ],
    "warnings": [
      "血管浮腫があらわれることがあるので、観察を十分に行うこと"
    ],
    "side_effects": [
      "重篤:血管浮腫（頻度不明）:顔面、口唇、舌、咽・喉頭等の腫脹を症状とする血管浮腫があらわれることがある",
      "非重篤:高血圧症:めまい、ふらつき、立ちくらみ、動悸、ほてり",
      "非重篤:慢性心不全:発疹、湿疹、蕁麻疹、そう痒"
    ],
    "interactions": [
      "薬物:リチウム製剤 - 機序:腎尿細管でのリチウムの再吸収が促進される"
    ],
    "compositions": [
      "有効成分:カンデサルタン シレキセチル 8.0mg",
      "添加物:L-ヒスチジン 7.8mg",
      "添加物:ポリソルベート80 0.5mg",
      "添加物:リン酸"
    ],
    "active_ingredients": [
      {
        "general_name": "カンデサルタン シレキセチル",
        "chemical_name": "2-エトキシ-1-{[2'-(1H-テトラゾール-5-イル)ビフェニル-4-イル]メチル}-1H-ベンゾイミダゾール-7-カルボン酸",
        "molecular_formula": "C24H20N6O3",
        "molecular_weight": "440.45",
        "nature": "白色の結晶性の粉末である。"
      }
    ]
  }
}
```

## 技術的特徴

### XMLパーサーの高度な機能

1. **ネストしたHeader構造の処理**
   - 疾患条件（〈高血圧症〉）と対象者（成人/小児）の階層構造を適切に解析
   - 再帰的なItem要素処理による複雑なXML構造への対応

2. **名前空間対応**
   - PMDA XML名前空間の適切な処理
   - `http://info.pmda.go.jp/namespace/prescription_drugs/package_insert/1.0`

3. **重篤度自動分類**
   - SeriousAdverseEvents → 重篤
   - OtherAdverseEvents → 非重篤
   - 重篤度優先フォーマット（`非重篤:条件:副作用`）
   - 医療従事者の臨床判断支援

4. **成分・含量の精密パーシング**
   - `ContainedAmount`要素から有効成分名と含量をペアで抽出
   - `InfoIndividualAdditive`要素から添加物名と含量をペアで抽出
   - 重量情報がない場合は成分名のみ出力
   - カテゴリ別テキスト出力（"有効成分:名称 含量"、"添加物:名称 含量"形式）

5. **有効成分詳細情報抽出**
   - PhyschemOfActIngredientsセクションから物理化学的情報を抽出
   - 一般名、化学名、分子式、分子量、性状等の詳細情報
   - XML内のタグ処理（Italic、Sub、Sup等）を適切に処理
   - **構造式情報は除外**（医師の処方判断に不要なため）

6. **複雑投与プロトコル対応**
   - 抗癌剤等のA法〜F法パターンの自動検出
   - 体表面積別用量テーブルの解析と統合
   - 対応薬剤：カペシタビン、TS-1、イリノテカン、パクリタキセル等
   - TblBlock要素からの体表面積範囲と対応用量の抽出

7. **XML構造ベース解析**
   - テキスト内容ではなくXML構造を基準とした解析
   - 企業間の記載揺れに影響されない堅牢な情報抽出
   - PMDA標準XML名前空間への完全対応

8. **原値保持**
   - XML/SGMLの値を分割せずに保持（例：「250国際単位」）
   - JSONの構造で意味を表現

## パフォーマンス

### 2つのバージョンを提供

#### 通常版（pmda_json_generator.py）
- **シングルプロセス処理**: 安定性重視
- **処理時間**: 約3分30秒（18,229医薬品）
- **メモリ使用量**: 中程度
- **互換性**: 全システムで安定動作

#### 最適化版（pmda_json_generator_optimized.py）
- **並列処理**: マルチプロセス + インテリジェントバッチ分割
- **処理時間**: 約23秒（18,229医薬品）**8.8倍高速化**
- **XMLパース削減**: 88.9%削減（SharedXMLProcessor使用）
- **動的負荷分散**: システムリソースに応じた最適化
- **バッチ処理**: メモリ効率を考慮した自動バッチサイズ調整

### 共通最適化機能
- **ファイル重複除去**: SHA-256ハッシュによる高速重複検出
- **成分重複除去**: カテゴリ間での重複成分自動除去
- **メモリ効率**: 大規模データセット処理に最適化
- **データ整合性**: 両バージョンで完全に同一の結果を出力

## 開発・カスタマイズ

### 新しいパーサーの追加

1. `src/parsers/`に新しいパーサーファイルを作成
2. `BaseParser`クラスを継承（推奨）
3. `pmda_json_generator.py`でパーサーを呼び出し

### コマンドライン引数

#### 通常版
```bash
python src/pmda_json_generator.py <pmda_directory> [--output OUTPUT_FILE]
```

#### 最適化版
```bash
python src/pmda_json_generator_optimized.py [OPTIONS]
  --input, -i          PMDAデータディレクトリ（デフォルト: pmda_all_yyyymmdd）
  --output, -o         出力JSONファイル（デフォルト: pmda_medicines_optimized.json）
  --workers, -w        並列ワーカー数（デフォルト: CPU数と16の小さい方）
  --batch-size, -b     バッチサイズ（デフォルト: 自動計算）
  --memory-limit, -m   メモリ制限MB（デフォルト: 2048）
  --use-threads        プロセスプールの代わりにスレッドプール使用
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 貢献

プルリクエストやイシューの報告を歓迎します。医療情報の正確性と安全性を最優先に開発を進めています。

## 重要な注意事項・免責事項

### 技術的挑戦としての位置づけ
- **このリポジトリは、医薬品データの利活用技術向上を目的とした技術的挑戦・研究開発プロジェクトです**
- データ構造化・解析技術の向上、ベクトル検索システムの構築、医療情報処理の効率化等の技術的課題解決を主目的としています
- 実際の医療現場での使用を前提としたものではなく、純粋に技術的・学術的な探求活動です

### 免責事項
- **開発者・貢献者・関係者は、このツールの使用により生じるいかなる損害、医療事故、誤診、治療の遅延、その他あらゆる直接的・間接的な損失について一切の責任を負いません**
- 抽出されたデータの正確性、完全性、適時性について保証するものではありません
- 医療判断や治療方針の決定においては、必ず最新の添付文書、医学的知見、専門医の判断に基づいて行ってください

### 使用上の制限
- このツールは医療従事者の情報検索支援を目的としており、医療判断の代替ではありません
- 抽出されたデータの医療利用については、必ず最新の添付文書等で確認し、専門医の監督の下で行ってください
- PMDAデータの利用は関連する利用規約に従ってください
- 本ツールの使用は完全に使用者の責任と判断において行ってください

### データの性質について
- 抽出されたデータは、XMLパーサーによる自動処理結果であり、人的チェックを経ていません
- データの解釈や医療への適用には、必ず医療従事者による専門的な判断が必要です
- 技術的な制約により、一部の情報が欠落、誤抽出される可能性があります